# Sistema Eleitoral (Supabase + Vercel)

Sistema web para cadastro de candidaturas, votacao e administracao com controle de fase. Esta versao usa **frontend direto no Supabase** (PostgreSQL + Auth), ideal para deploy simples na Vercel.

## Arquitetura (visao geral)
- Frontend: React + Vite + TypeScript + Tailwind
- Dados/Auth: Supabase (PostgreSQL + Auth)
- Deploy: Vercel (apenas o frontend)

## Setup local

### 1) Instalar dependencias
```bash
npm install
```

### 2) Configurar ambiente do frontend
```bash
cp frontend/.env.example frontend/.env
```

Preencha no `frontend/.env`:
- `VITE_SUPABASE_URL`
- `VITE_SUPABASE_ANON_KEY`

### 3) Rodar SQL inicial no Supabase (tabelas + RLS)
Use o SQL abaixo no Supabase SQL Editor.

```sql
create type candidate_status as enum ('PENDENTE','APROVADO','REJEITADO');

create table settings (
  key text primary key,
  value text not null
);

create table candidates (
  id bigint generated by default as identity primary key,
  name text not null,
  grade_year text not null,
  class_letter text not null check (class_letter in ('A','B','C')),
  status candidate_status not null default 'PENDENTE',
  created_at timestamptz not null default now()
);

create table votes (
  id bigint generated by default as identity primary key,
  candidate_id bigint not null references candidates(id) on delete cascade,
  created_at timestamptz not null default now()
);

create table profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  is_admin boolean not null default false
);

create function public.handle_new_user() returns trigger as $$
begin
  insert into public.profiles (id) values (new.id);
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
after insert on auth.users
for each row execute procedure public.handle_new_user();

alter table settings enable row level security;
alter table candidates enable row level security;
alter table votes enable row level security;
alter table profiles enable row level security;

create policy "settings_read_all" on settings for select using (true);
create policy "settings_admin_insert" on settings for insert with check (
  exists (select 1 from profiles p where p.id = auth.uid() and p.is_admin)
);
create policy "settings_admin_update" on settings for update using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.is_admin)
);
create policy "settings_admin_delete" on settings for delete using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.is_admin)
);

create policy "profiles_read_own" on profiles for select using (auth.uid() = id);

create policy "candidates_read_public" on candidates for select using (status = 'APROVADO');
create policy "candidates_read_admin" on candidates for select using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.is_admin)
);
create policy "candidates_insert_public" on candidates for insert with check (
  exists (select 1 from settings s where s.key = 'phase' and s.value = 'CANDIDATURA')
);
create policy "candidates_update_admin" on candidates for update using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.is_admin)
);
create policy "candidates_delete_admin" on candidates for delete using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.is_admin)
);

create policy "votes_insert_public" on votes for insert with check (
  exists (select 1 from settings s where s.key = 'phase' and s.value = 'VOTACAO')
  and exists (select 1 from candidates c where c.id = candidate_id and c.status = 'APROVADO')
);
create policy "votes_select_admin" on votes for select using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.is_admin)
);
create policy "votes_delete_admin" on votes for delete using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.is_admin)
);

insert into settings (key, value) values ('phase', 'CANDIDATURA') on conflict do nothing;
```

### 4) Criar usuario admin no Supabase Auth
- Crie um usuario com email e senha no painel do Supabase.
- Pegue o `id` desse usuario em Auth -> Users.
- Rode no SQL Editor:
```sql
update profiles set is_admin = true where id = 'SEU-USER-ID';
```

### 5) Rodar o frontend
```bash
npm run dev
```

## Deploy na Vercel
- Configure o projeto com **Root Directory** = `frontend`.
- Build command: `npm run build`.
- Output directory: `dist`.
- Environment Variables:
`VITE_SUPABASE_URL`
`VITE_SUPABASE_ANON_KEY`

## Observacoes importantes
- Nao use a senha do banco no frontend.
- As chaves usadas no frontend sao apenas `anon` (publicas).
